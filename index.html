<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Genshin Tool</title>
    <style>
        :root {
            --bg-color: #1e2124;
            --card-color: #282b30;
            --primary-text: #ffffff;
            --secondary-text: #b9bbbe;
            --accent-blue: #5865f2;
            --accent-gold: #f0b90b;
            --accent-purple: #a256e1;
            --accent-light-blue: #58a6f8;
            --green-color: #3ba55d;
            --yellow-color: #faa61a;
            --red-color: #ed4245;
            --border-color: #36393f;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--primary-text);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            height: 100vh;
            box-sizing: border-box;
            overflow: hidden;
        }

        .header-section { 
            flex-shrink: 0;
            display: flex; justify-content: space-between; align-items: center; 
            border-bottom: 1px solid var(--border-color); padding-bottom: 15px; margin-bottom: 20px;
            width: 100%; max-width: 1200px; margin-left: auto; margin-right: auto;
            transition: opacity 0.3s ease;
        }
        h1 { color: var(--primary-text); font-size: 2.5em; margin: 0; }
        #live-clock { font-size: 1.5em; color: var(--secondary-text); font-weight: bold; }
        
        main {
            flex-grow: 1; width: 100%; display: flex;
            justify-content: center; align-items: flex-start;
            position: relative;
            overflow-y: auto;
            padding: 20px 0;
        }
        
        /* --- Menu & View Structure --- */
        .view { display: none; width: 100%; max-width: 1200px; }
        .view.active { display: block; animation: expand-in 0.3s ease-out forwards; }
        .view.contracting { animation: contract-out 0.3s ease-in forwards !important; }
        @keyframes expand-in { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        @keyframes contract-out { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(0.95); } }
        
        #main-menu { align-self: center; position: relative; width: 100%; max-width: 500px; aspect-ratio: 1 / 1; }
        #main-menu.active { display: block; }

        .menu-button {
            position: absolute; width: 120px; height: 120px;
            background-color: var(--card-color); border: 2px solid var(--border-color);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: transform 0.2s ease, border-color 0.2s ease;
            /* <<< MODIFIED: Using margins for centering instead of transform */
            margin-left: -60px;
            margin-top: -60px;
        }
        /* <<< MODIFIED: Hover transform is now just scale */
        .menu-button:hover { 
            transform: scale(1.15); 
            border-color: var(--accent-blue); 
        }
        .menu-button:hover .tooltip { opacity: 1; }
        .menu-button svg { width: 50px; height: 50px; fill: var(--secondary-text); transition: fill 0.2s ease; }
        .menu-button:hover svg { fill: var(--primary-text); }
        /* <<< MODIFIED: Removed transform from all positioning rules */
        #menu-btn-tasks { top: 10%; left: 50%; }
        #menu-btn-primos { top: 45%; left: 95%; }
        #menu-btn-gacha { top: 90%; left: 75%; }
        #menu-btn-calendar { top: 90%; left: 25%; }
        #menu-btn-map { top: 45%; left: 5%; }

        #menu-btn-settings {
            position: fixed;
            bottom: 25px;
            left: 25px;
            width: 60px;
            height: 60px;
            background-color: var(--card-color);
            border: 2px solid var(--border-color);
            border-radius: 50%;
            display: none; 
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1001;
            transition: transform 0.2s ease, border-color 0.2s ease;
        }
        #menu-btn-settings:hover {
            transform: scale(1.15);
            border-color: var(--accent-blue);
        }
        #menu-btn-settings svg {
            width: 30px;
            height: 30px;
            fill: var(--secondary-text);
            transition: fill 0.2s ease;
        }
        #menu-btn-settings:hover svg {
            fill: var(--primary-text);
        }
        
        .tooltip { position: absolute; bottom: -35px; left: 50%; transform: translateX(-50%); background-color: var(--bg-color); color: var(--primary-text); padding: 5px 10px; border-radius: 4px; font-size: 0.9em; opacity: 0; transition: opacity 0.2s ease; pointer-events: none; white-space: nowrap; }

        #back-button-hotspot {
            position: fixed;
            top: 0;
            right: 0;
            width: 100px;
            height: 100px;
            z-index: 1002;
            display: none;
        }
        .btn-back-icon {
            position: absolute; 
            top: 25px; right: 25px;
            width: 44px; height: 44px;
            background: var(--card-color); border: 1px solid var(--border-color);
            padding: 10px; cursor: pointer; border-radius: 50%;
            transition: background-color 0.2s ease, transform 0.2s ease, opacity 0.3s ease;
        }
        #back-button-hotspot.visible { display: block; }
        .btn-back-icon:hover { background-color: var(--border-color); transform: scale(1.1); }
        .btn-back-icon svg { width: 24px; height: 24px; fill: var(--secondary-text); display: block; }

        body.map-is-active main { padding: 0; }
        body.map-is-active #back-button-hotspot .btn-back-icon { opacity: 0; }
        body.map-is-active #back-button-hotspot:hover .btn-back-icon { opacity: 1; }
        #view-map.active {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            max-width: none;
            padding: 0;
            background-color: var(--bg-color);
        }
        #interactive-map-iframe { width: 100%; height: 100%; border: none; }

        .app-layout { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; }
        .layout-column, .single-column-view { background-color: var(--card-color); border: 1px solid var(--border-color); border-radius: 8px; padding: 25px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); }
        h2 { text-align: center; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-top: 0; font-size: 1.6em; }
        
        .btn { padding: 15px; border: none; border-radius: 5px; font-size: 1.1em; font-weight: bold; cursor: pointer; transition: background-color 0.2s; }
        .btn-primary { background-color: var(--accent-blue); color: var(--primary-text); }
        .btn-action { background-color: var(--green-color); color: var(--primary-text); }
        .btn-secondary { background-color: #4f545c; color: var(--primary-text); }
        .btn-clear { background-color: var(--red-color); color: var(--primary-text); }
        .btn-primary:hover, #copy-script-btn:hover { background-color: #4752c4; }
        .btn-action:hover { background-color: #2d8a4c; }
        .btn-secondary:hover { background-color: #40444b; }
        .btn-clear:hover { background-color: #c9302c; }

        .controls-group { display: flex; flex-direction: column; gap: 10px; margin-top: 20px; }
        .settings-section { border-top: 1px solid var(--border-color); margin-top: 20px; padding-top: 20px; }
        .settings-section h3 { margin-top: 0; text-align: center; }

        .stats { text-align: center; margin-bottom: 25px; padding: 15px; background-color: rgba(0,0,0,0.2); border-radius: 6px; }
        .stat-item p { margin: 0; font-size: 1.8em; font-weight: bold; }
        
        .task-list { list-style: none; padding: 0; flex-grow: 1; }
        .task-item { display: flex; align-items: center; padding: 12px; background-color: var(--bg-color); border-radius: 5px; margin-bottom: 8px; }
        .task-item.is-event, .task-item label, .task-item input { cursor: pointer; }
        .task-item.locked { opacity: 0.6; pointer-events: none; }
        .task-item input[type="checkbox"] { width: 20px; height: 20px; margin-right: 15px; accent-color: var(--accent-blue); }
        .task-item label { flex-grow: 1; }
        .task-item .fake-checkbox { width: 18px; height: 18px; margin-right: 15px; border: 2px solid var(--secondary-text); border-radius: 3px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .task-item .fake-checkbox.completed::after { content: '✔'; }
        .streak-counter { margin-left: auto; padding-left: 10px; flex-shrink: 0; }

        .instructions-container { background-color: rgba(0,0,0,0.2); border-radius: 6px; margin: 20px auto; max-width: 800px; }
        .instructions-container summary { cursor: pointer; font-weight: bold; padding: 15px; font-size: 1.1em; color: var(--accent-blue); list-style: none; }
        .code-block-wrapper { background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 5px; padding: 10px; display: flex; align-items: center; gap: 10px; margin-top: 5px; }
        .code-block-wrapper pre { white-space: pre-wrap; word-break: break-all; margin: 0; flex-grow: 1; font-family: 'Consolas', 'Monaco', monospace; font-size: 0.9em; }
        #copy-script-btn { padding: 8px 12px; }

        /* --- Gacha View Styles --- */
        .gacha-view-layout { display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; align-items: flex-start; }
        .gacha-banner-card { flex: 1; min-width: 300px; max-width: 380px; background-color: var(--card-color); border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; display: flex; flex-direction: column; gap: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .gacha-banner-card h3 { margin: 0; padding: 0; font-size: 1.4em; border-bottom: none; text-align: left; }
        .pity-block { background-color: var(--bg-color); padding: 15px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; }
        .pity-info { display: flex; flex-direction: column; gap: 4px; }
        .pity-title { font-size: 1.1em; font-weight: bold; color: var(--primary-text); }
        .pity-guarantee { font-size: 0.9em; color: var(--secondary-text); display: flex; align-items: center; }
        .pity-value-display { font-size: 2.8em; font-weight: bold; line-height: 1; }
        .pity-value-display.lifetime { color: var(--primary-text); }
        .pity-value-display.rarity-5 { color: var(--accent-gold); }
        .pity-value-display.rarity-4 { color: var(--accent-purple); }
        
        .gacha-details-wrapper { margin-top: 10px; border-top: 1px solid var(--border-color); padding-top: 15px; }
        .gacha-details-wrapper summary { cursor: pointer; font-weight: bold; color: var(--accent-blue); padding: 5px; border-radius: 4px; transition: background-color 0.2s; list-style:-webkit-details-marker; list-style:inherit; }
        .gacha-details-wrapper summary:hover { background-color: var(--border-color); }
        .gacha-details-wrapper[open] summary { margin-bottom: 15px; }
        .gacha-details-content { display: flex; flex-direction: column; gap: 15px; }
        .gacha-details-grid { display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 8px 12px; font-size: 0.95em; }
        .gacha-grid-header { font-weight: bold; color: var(--secondary-text); text-align: right; padding-bottom: 5px; border-bottom: 1px solid var(--border-color); }
        .gacha-grid-header:first-child { text-align: left; }
        .gacha-grid-label { text-align: left; display: flex; align-items: center; }
        .gacha-grid-label.indented { padding-left: 20px; color: var(--secondary-text); }
        .gacha-grid-value { text-align: right; font-weight: bold; }
        .gacha-grid-value.gold { color: var(--accent-gold); }

        .gacha-pulls-container { display: flex; flex-wrap: wrap; gap: 8px; padding-top: 15px; border-top: 1px solid var(--border-color); }
        .gacha-pull { background-color: var(--bg-color); border: 2px solid var(--border-color); padding: 4px 10px; border-radius: 15px; font-size: 0.9em; display:flex; align-items:center; }
        .gacha-pull.win { border-color: var(--accent-gold); }
        .pity-value { font-weight: bold; margin-left: 8px; }
        .pity-value.pity-high { color: var(--red-color); }
        .pity-value.pity-low { color: var(--green-color); }
        .pity-value.pity-mid { color: var(--primary-text); }

        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .calendar-controls { display: flex; align-items: center; gap: 15px; }
        .year-selector { display: flex; align-items: center; gap: 5px; }
        .calendar-header button { padding: 5px 12px; font-size: 1em; }
        #current-year-display { font-size: 1.2em; padding: 0 5px; }
        .calendar-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
        .month { background-color: var(--bg-color); padding: 15px; border-radius: 6px; }
        .day-headers, .days-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        .day-headers div { text-align: center; font-weight: bold; }
        .day-cell { position: relative; aspect-ratio: 1 / 1; background-color: var(--card-color); border-radius: 4px; border: 1px solid transparent; }
        .day-cell span { position: absolute; top: 4px; left: 4px; font-size: 0.8em; }
        .pull-count { position: absolute; bottom: 4px; right: 4px; font-size: 1.1em; font-weight: bold; }
        .day-cell.today { border-color: var(--accent-blue); }
        .day-cell.has-pulls:hover { background-color: var(--border-color); cursor: pointer; }
        .day-cell.highlight-red { background-color: rgba(237, 66, 69, 0.4); }
        .day-cell.highlight-yellow { background-color: rgba(250, 166, 26, 0.4); }
        .day-cell.highlight-green { background-color: rgba(59, 165, 93, 0.4); }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
        .modal-overlay.visible { opacity: 1; pointer-events: auto; }
        .modal-content { background-color: var(--card-color); padding: 25px; border-radius: 8px; width: 90%; max-width: 500px; text-align: center; }
        .modal-input { width: 100%; padding: 10px; margin-bottom: 20px; box-sizing: border-box; background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 5px; color: var(--primary-text); font-size: 1em; }
        .modal-buttons { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
        .pull-breakdown-list { list-style: none; padding: 0; text-align: left; max-height: 50vh; overflow-y: auto; }
        .pull-breakdown-list li { background-color: var(--bg-color); border-radius: 4px; padding: 8px 12px; margin-bottom: 5px; }
        .rarity-5 { color: var(--accent-gold); } .rarity-4 { color: var(--accent-purple); } .rarity-3 { color: var(--accent-light-blue); }
    </style>
</head>
<body>
    <div class="header-section"><h1>Genshin Tool</h1><div id="live-clock">--:--:--</div></div>
    <div id="back-button-hotspot">
        <button class="btn-back-icon" id="btn-back-main" title="Back to Menu"><svg viewBox="0 0 24 24"><path d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z" /></svg></button>
    </div>
    <main>
        <div id="main-menu" class="view">
            <div id="menu-btn-tasks" class="menu-button" data-view="view-tasks"><svg viewBox="0 0 24 24"><path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20M8.5,13.5L10.5,15.5L15,11L16.5,12.5L10.5,18.5L7,15L8.5,13.5Z" /></svg><span class="tooltip">Tasks</span></div>
            <div id="menu-btn-primos" class="menu-button" data-view="view-primos"><svg viewBox="0 0 24 24"><path d="M12,1L9,9L1,12L9,15L12,23L15,15L23,12L15,9L12,1Z" /></svg><span class="tooltip">Primogems</span></div>
            <div id="menu-btn-map" class="menu-button" data-view="view-map">
                <svg viewBox="0 0 24 24"><path d="M12,11.5A2.5,2.5 0 0,1 9.5,9A2.5,2.5 0 0,1 12,6.5A2.5,2.5 0 0,1 14.5,9A2.5,2.5 0 0,1 12,11.5M12,2A7,7 0 0,0 5,9C5,14.25 12,22 12,22C12,22 19,14.25 19,9A7,7 0 0,0 12,2Z"/></svg>
                <span class="tooltip">Interactive Map</span>
            </div>
            <div id="menu-btn-gacha" class="menu-button" data-view="view-gacha"><svg viewBox="0 0 24 24"><path d="M12,17.27L18.18,21L17,14.63L22,9.72L15.45,8.81L12,2.5L8.55,8.81L2,9.72L7,14.63L5.82,21L12,17.27Z" /></svg><span class="tooltip">Gacha Log</span></div>
            <div id="menu-btn-calendar" class="menu-button" data-view="view-calendar"><svg viewBox="0 0 24 24"><path d="M19,19H5V8H19M19,3H18V1H16V3H8V1H6V3H5C3.89,3 3,3.9 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5A2,2 0 0,0 19,3M16.5,12H12.5V17H16.5V12Z" /></svg><span class="tooltip">Calendar</span></div>
        </div>
        <div id="view-map" class="view"></div>
        <div id="view-tasks" class="view"></div><div id="view-primos" class="view"></div><div id="view-gacha" class="view"></div><div id="view-calendar" class="view"></div><div id="view-settings" class="view"></div>
    </main>
    <div id="menu-btn-settings" data-view="view-settings">
        <svg viewBox="0 0 24 24"><path d="M19.43,12.98C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.34 19.43,11L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.66 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.21,8.95 2.27,9.22 2.46,9.37L4.57,11C4.53,11.34 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.98L2.46,14.63C2.27,14.78 2.21,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.03 4.95,18.95L7.44,17.94C7.96,18.34 8.5,18.68 9.13,18.93L9.5,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.5,18.68 16.04,18.34 16.56,17.94L19.05,18.95C19.27,19.03 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.98M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5Z" /></svg>
    </div>
    <div id="custom-modal" class="modal-overlay"></div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            function setViewHTML() {
                getEl('view-tasks').innerHTML = `<div class="app-layout"><div class="layout-column"><h2>Daily Tasks</h2><ul id="daily-tasks-list" class="task-list"></ul></div><div class="layout-column"><h2>Weekly Tasks <span id="weekly-reset-counter" class="streak-counter"></span></h2><ul id="weekly-tasks-list" class="task-list"></ul></div></div>`;
                getEl('view-primos').innerHTML = `<div class="single-column-view" style="max-width: 500px; margin: auto;"><h2>Primogem Stats</h2><div class="stats"><div class="stat-item"><h3>DAILY STREAK</h3><p id="daily-streak">0</p></div><div class="stat-item"><h3>PRIMOGEMS</h3><p><span id="primo-count">0</span> / <span id="primo-goal">16000</span></p></div></div><div class="controls-group"><button id="add-primo-btn" class="btn btn-primary">Add Primogems</button><button id="set-goal-btn" class="btn btn-primary">Set Primogem Goal</button></div></div>`;
                getEl('view-map').innerHTML = `<iframe id="interactive-map-iframe" src="https://genshin-impact-map.appsample.com/?map=teyvat"></iframe>`;
                getEl('view-gacha').innerHTML = `<div class="single-column-view"><h2 style="text-align:center;">Gacha Log Analyzer</h2><details class="instructions-container"><summary>► How to Get Your Wish URL</summary><div class="instructions-content" style="padding:0 15px 15px 15px;"><ol style="padding-left:20px;margin:0;line-height:1.6;"><li>Open Genshin Impact on your PC.</li><li>Open the Wish History in the game and wait for it to fully load.</li><li>Press the START key, search for "PowerShell", and open it.</li><li>Copy & paste the script below into PowerShell:</li></ol><div class="code-block-wrapper"><pre id="powershell-script"></pre><button id="copy-script-btn" class="btn btn-primary">Copy</button></div><ol start="5" style="padding-left:20px;margin-top:10px;line-height:1.6;"><li>Press ENTER. The link will be copied to your clipboard.</li><li>Click the button below and paste the link.</li></ol></div></details><div class="controls-group" style="max-width: 400px; margin: 0 auto 20px auto;"><button id="import-gacha-btn" class="btn btn-action">Import Gacha Log</button></div><div id="gacha-stats-container"></div></div>`;
                getEl('view-calendar').innerHTML = `<div class="single-column-view"><div class="calendar-header"><div class="calendar-controls"><h2>Yearly Wish Calendar</h2></div><div class="year-selector"><button id="prev-year-btn" class="btn btn-secondary">&lt;</button><span id="current-year-display"></span><button id="next-year-btn" class="btn btn-secondary">&gt;</button></div></div><div id="calendar-grid" class="calendar-grid"></div></div>`;
                getEl('view-settings').innerHTML = `<div class="single-column-view" style="max-width: 500px; margin: auto;"><h2>Settings</h2><div class="settings-section"><h3>General Resets</h3><div class="controls-group" style="margin-top:0;"><button id="manual-reset-btn" class="btn btn-secondary">Perform Daily Task Reset</button><button id="reset-primo-btn" class="btn btn-secondary">Reset Primogem Count</button></div></div><div class="settings-section"><h3>Date Override</h3><p id="custom-date-display" style="text-align:center; color: var(--secondary-text); margin-bottom: 10px;"></p><div class="controls-group" style="margin-top:0;"><button id="set-date-btn" class="btn btn-secondary">Set Custom Date</button><button id="sync-date-btn" class="btn btn-secondary">Sync to Today</button></div></div><div class="settings-section"><h3>Danger Zone</h3><div class="controls-group" style="margin-top:0;"><button id="reset-all-btn" class="btn btn-clear">Clear & Reset All Data</button></div></div></div>`;
                getEl('custom-modal').innerHTML = `<div class="modal-content"><h3 id="modal-title"></h3><p id="modal-message"></p><div id="modal-custom-content"></div><input type="text" id="modal-input" class="modal-input" style="display: none;"><div class="modal-buttons"><button id="modal-cancel-btn" class="btn btn-secondary">Cancel</button><button id="modal-confirm-btn" class="btn btn-primary">Confirm</button></div></div>`;
                getEl('powershell-script').textContent = `Set-ExecutionPolicy Bypass -Scope Process -Force; [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072; iex "&{$((New-Object System.Net.WebClient).DownloadString('https://gist.githubusercontent.com/cheesekiller2/5433a3d7cd9f563e43a71ab574dd25e1/raw/8c3cf4442d60280a6a623289b636539096cf61d0/getlink-genshintool.ps1'))} global"`;
            }

            const getEl = (id) => document.getElementById(id);
            let state;
            const STORAGE_KEY = 'genshinTrackerData_v2_stable';
            const STANDARD_5_STARS = ['Keqing', 'Mona', 'Qiqi', 'Diluc', 'Jean', 'Dehya', 'Tighnari'];
            
            const getAppDate = () => state.customDate ? new Date(state.customDate + 'T12:00:00') : new Date();
            
            const toLocalISOString = (date) => {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };

            function showView(viewId) {
                const animationDuration = 300;
                const activeView = document.querySelector('.view.active');
                const backButtonHotspot = getEl('back-button-hotspot');
                const header = document.querySelector('.header-section');
                const settingsBtn = getEl('menu-btn-settings');

                if (activeView?.id === viewId) return;

                settingsBtn.style.display = (viewId === 'main-menu') ? 'flex' : 'none';

                if (viewId === 'view-map') {
                    document.body.classList.add('map-is-active');
                    header.style.display = 'none';
                } else {
                    document.body.classList.remove('map-is-active');
                    header.style.display = 'flex';
                }

                if (activeView) {
                    activeView.classList.add('contracting');
                    setTimeout(() => {
                        activeView.classList.remove('active', 'contracting');
                        const newView = getEl(viewId);
                        if (newView) {
                            newView.classList.add('active');
                            backButtonHotspot.classList.toggle('visible', newView.id !== 'main-menu');
                        }
                    }, animationDuration);
                } else {
                    const newView = getEl(viewId);
                    if (newView) {
                        newView.classList.add('active');
                    }
                    backButtonHotspot.classList.toggle('visible', viewId !== 'main-menu');
                }
            }

            const getDefaultState = () => ({
                dailyTasks: [{ name: 'Do commission', completed: false, streak: 0 }, { name: 'Do event (if any)', completed: false, streak: 0, isEvent: true }, { name: 'Artifacts fodder farming route', completed: false, streak: 0 }, { name: 'Use all my resin', completed: false, streak: 0 }, { name: 'Do battlepass', completed: false, streak: 0 }, { name: 'Explore/Chests for 30 mins', completed: false, streak: 0 }, { name: 'World quests for friendship', completed: false, streak: 0 }],
                weeklyTasks: [{ name: 'Reputation Commissions', completed: false, streak: 0 }, { name: 'Weekly Bosses', completed: false, streak: 0 }],
                primogemCount: 0, primogemGoal: 16000, dailyStreak: 0, dailyResetsSinceWeekly: 0, lastDailyReset: new Date().toISOString(), 
                gachaLog: null, calendarDisplayYear: new Date().getFullYear(), customDate: null
            });

            const loadState = () => {
                let savedState = localStorage.getItem(STORAGE_KEY);
                state = getDefaultState();
                if (savedState) {
                    const loaded = JSON.parse(savedState);
                    Object.assign(state, loaded);
                    if (!state.calendarDisplayYear) state.calendarDisplayYear = new Date().getFullYear();
                }
            };
            const saveState = () => localStorage.setItem(STORAGE_KEY, JSON.stringify(state));

            function renderAll() { renderTasks(); renderPrimos(); renderGachaStats(); renderCalendar(); renderSettings(); }
            
            function renderTasks() {
                const renderList = (listEl, data, type) => {
                    if (!listEl) return; listEl.innerHTML = '';
                    data.forEach((task, index) => {
                        const li = document.createElement('li');
                        li.className = `task-item ${task.isEvent ? 'is-event' : ''}`;
                        if (task.completed) li.classList.add('locked');
                        const commonHtml = `<label>${task.name}</label><span class="streak-counter">Streak: ${task.streak}</span>`;
                        li.innerHTML = task.isEvent ? `<div class="fake-checkbox ${task.completed ? 'completed' : ''}"></div>${commonHtml}` : `<input type="checkbox" id="${type}-${index}" ${task.completed ? 'checked' : ''}>${commonHtml}`;
                        if (task.isEvent) { li.addEventListener('click', () => handleEventTaskClick(index));
                        } else {
                            const input = li.querySelector('input');
                            input.addEventListener('change', () => toggleTask(type, index));
                        }
                        listEl.appendChild(li);
                    });
                };
                renderList(getEl('daily-tasks-list'), state.dailyTasks, 'daily');
                renderList(getEl('weekly-tasks-list'), state.weeklyTasks, 'weekly');
                const daysLeft = 7 - (state.dailyResetsSinceWeekly || 0);
                getEl('weekly-reset-counter').textContent = `Reset in: ${daysLeft} ${daysLeft === 1 ? 'day' : 'days'}`;
            }

            function renderPrimos() { getEl('daily-streak').textContent = state.dailyStreak; getEl('primo-count').textContent = state.primogemCount; getEl('primo-goal').textContent = state.primogemGoal; }
            
            function renderGachaStats() {
                const container = getEl('gacha-stats-container');
                if (!container) return;
                if (!state.gachaLog || !state.gachaLog.wishes || state.gachaLog.wishes.length === 0) {
                    container.innerHTML = `<p style="text-align:center; padding: 20px;">No gacha data found. Please import your log.</p>`;
                    return;
                }
                const allWishes = state.gachaLog.wishes;
                const bannerConfigs = [
                    { id: '301', name: 'Character Event', type: 'character', pity5: 90, pity4: 10 },
                    { id: '302', name: 'Weapon Event', type: 'weapon', pity5: 80, pity4: 10 },
                    { id: '200', name: 'Standard', type: 'standard', pity5: 90, pity4: 10 }
                ];

                const primoIconSvg = `<svg viewBox="0 0 24 24" style="width: 1em; height: 1em; fill: var(--accent-light-blue); vertical-align: -0.15em; margin-right: 5px;"><path d="M12,1L9,9L1,12L9,15L12,23L15,15L23,12L15,9L12,1Z" /></svg>`;
                const f = (num, digits = 2) => (num || 0).toFixed(digits);
                const getPityClass = (pity) => {
                    if (pity >= 74) return 'pity-high';
                    if (pity <= 20) return 'pity-low';
                    return 'pity-mid';
                };

                let html = '<div class="gacha-view-layout">';

                bannerConfigs.forEach(config => {
                    const bannerWishes = allWishes.filter(w => w.gacha_type === config.id);
                    const stats = analyzeBannerData(bannerWishes, config.type);
                    if (!stats) return;

                    const totalPrimos = (stats.totalWishes * 160).toLocaleString();
                    
                    let detailsHtml = '<div class="gacha-details-grid">';
                    detailsHtml += `<div class="gacha-grid-header"></div><div class="gacha-grid-header">Total</div><div class="gacha-grid-header">Percent</div><div class="gacha-grid-header">Pity AVG</div>`;
                    detailsHtml += `<div class="gacha-grid-label rarity-5">5 ★</div><div class="gacha-grid-value gold">${stats.five.total}</div><div class="gacha-grid-value">${f(stats.five.percent)}%</div><div class="gacha-grid-value gold">${f(stats.five.avgPity, 1)}</div>`;
                    if (config.type === 'character' && stats.five.total > 0) {
                        detailsHtml += `<div class="gacha-grid-label indented">↳ Win 50/50</div><div class="gacha-grid-value">${stats.five.wins}</div><div class="gacha-grid-value">${f(stats.five.winRate)}%</div><div class="gacha-grid-value">-</div>`;
                    }
                    detailsHtml += `<div class="gacha-grid-label rarity-4">4 ★</div><div class="gacha-grid-value" style="color:var(--accent-purple)">${stats.four.total}</div><div class="gacha-grid-value">${f(stats.four.percent)}%</div><div class="gacha-grid-value">${f(stats.four.avgPity, 2)}</div>`;
                    if (config.type === 'character' && stats.four.total > 0) {
                        detailsHtml += `<div class="gacha-grid-label indented">↳ Character</div><div class="gacha-grid-value">${stats.four.chars.total}</div><div class="gacha-grid-value">${f(stats.four.chars.percent)}%</div><div class="gacha-grid-value">${f(stats.four.chars.avgPity, 2)}</div>`;
                        detailsHtml += `<div class="gacha-grid-label indented">↳ Weapon</div><div class="gacha-grid-value">${stats.four.weapons.total}</div><div class="gacha-grid-value">${f(stats.four.weapons.percent)}%</div><div class="gacha-grid-value">${f(stats.four.weapons.avgPity, 2)}</div>`;
                    }
                    detailsHtml += '</div>';

                    if (stats.five.list.length > 0) {
                        const pullsHtml = stats.five.list.map(p => `<div class="gacha-pull ${p.win ? 'win' : ''}"><span>${p.name}</span><span class="pity-value ${getPityClass(p.pity)}">${p.pity}</span></div>`).join('');
                        detailsHtml += `<div class="gacha-pulls-container">${pullsHtml}</div>`;
                    }
                    
                    html += `
                        <div class="gacha-banner-card">
                            <h3>${config.name}</h3>
                            <div class="pity-block">
                                <div class="pity-info"><span class="pity-title">Lifetime Pulls</span><span class="pity-guarantee">${primoIconSvg} ${totalPrimos}</span></div>
                                <div class="pity-value-display lifetime">${stats.totalWishes}</div>
                            </div>
                            <div class="pity-block">
                                <div class="pity-info"><span class="pity-title">5★ Pity</span><span class="pity-guarantee">Guaranteed at ${config.pity5}</span></div>
                                <div class="pity-value-display rarity-5">${stats.pity.current5}</div>
                            </div>
                            <div class="pity-block">
                                <div class="pity-info"><span class="pity-title">4★ Pity</span><span class="pity-guarantee">Guaranteed at ${config.pity4}</span></div>
                                <div class="pity-value-display rarity-4">${stats.pity.current4}</div>
                            </div>
                            <details class="gacha-details-wrapper"><summary>Show Full Stats</summary><div class="gacha-details-content">${detailsHtml}</div></details>
                        </div>
                    `;
                });

                html += '</div>';
                container.innerHTML = html;
            }

            function renderCalendar() {
                const calendarGrid = getEl('calendar-grid');
                if (!calendarGrid) return;
                const year = state.calendarDisplayYear;
                getEl('current-year-display').textContent = year;
                getEl('next-year-btn').disabled = year >= getAppDate().getFullYear();

                if (!state.gachaLog?.wishes) { calendarGrid.innerHTML = `<p style="text-align: center; grid-column: 1 / -1;">Import gacha log to see calendar.</p>`; return; }
                
                const wishesForYear = state.gachaLog.wishes.filter(w => new Date(w.time).getFullYear() === year);
                const pullsByDay = wishesForYear.reduce((acc, wish) => { const dayKey = wish.time.split(' ')[0]; acc[dayKey] = (acc[dayKey] || 0) + 1; return acc; }, {});
                const todayKey = toLocalISOString(getAppDate());
                const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
                
                calendarGrid.innerHTML = monthNames.map((name, month) => {
                    const firstDay = new Date(year, month, 1).getDay();
                    const daysInMonth = new Date(year, month + 1, 0).getDate();
                    let daysHtml = Array(firstDay).fill('<div class="day-cell empty"></div>').join('');
                    for (let day = 1; day <= daysInMonth; day++) {
                        const dayKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                        const pullCount = pullsByDay[dayKey];
                        let hClass = pullCount > 5 ? 'highlight-green' : pullCount === 5 ? 'highlight-yellow' : pullCount > 0 ? 'highlight-red' : '';
                        if (dayKey === todayKey) hClass += ' today';
                        if (pullCount) hClass += ' has-pulls';
                        daysHtml += `<div class="day-cell ${hClass}" data-date="${dayKey}"><span>${day}</span>${pullCount ? `<div class="pull-count">${pullCount}</div>` : ''}</div>`;
                    }
                    return `<div class="month"><h4>${name}</h4><div class="day-headers">${['S','M','T','W','T','F','S'].map(d=>`<div>${d}</div>`).join('')}</div><div class="days-grid">${daysHtml}</div></div>`;
                }).join('');
                calendarGrid.querySelectorAll('.has-pulls').forEach(cell => cell.addEventListener('click', () => showDailyBreakdown(cell.dataset.date)));
            }
            
            function renderSettings() {
                const display = getEl('custom-date-display');
                const syncBtn = getEl('sync-date-btn');
                if (state.customDate) {
                    display.textContent = `Using custom date: ${state.customDate}`;
                    syncBtn.style.display = 'block';
                } else {
                    display.textContent = 'Using real system time.';
                    syncBtn.style.display = 'none';
                }
            }

            async function showModal(options) {
                const modal = getEl('custom-modal'), modalTitle = getEl('modal-title'), modalMessage = getEl('modal-message'), modalInput = getEl('modal-input'), modalCustom = getEl('modal-custom-content'), modalCancelBtn = getEl('modal-cancel-btn'), modalConfirmBtn = getEl('modal-confirm-btn');
                
                modalTitle.textContent = options.title || '';
                modalMessage.style.display = options.message ? 'block' : 'none';
                modalMessage.innerHTML = options.message || '';
                
                modalCustom.innerHTML = options.customHtml || '';
                modalCustom.style.display = options.customHtml ? 'block' : 'none';

                modalInput.style.display = options.type === 'prompt' ? 'block' : 'none';
                if (options.type === 'prompt') {
                    modalInput.value = options.defaultValue || '';
                    modalInput.placeholder = options.placeholder || '';
                }

                modalCancelBtn.style.display = (options.type === 'alert') ? 'none' : 'flex';
                modalConfirmBtn.textContent = options.confirmText || 'Confirm';

                modal.classList.add('visible');
                if (options.type === 'prompt') modalInput.focus();
                
                return new Promise((resolve) => {
                    const hideAndResolve = (value) => {
                        modal.classList.remove('visible');
                        setTimeout(() => resolve(value), 50); 
                    };
                    modalConfirmBtn.onclick = () => hideAndResolve(options.type === 'prompt' ? modalInput.value : true);
                    modalCancelBtn.onclick = () => hideAndResolve(false);
                });
            }
            
            function showDailyBreakdown(dateKey) {
                const pulls = state.gachaLog.wishes.filter(w => w.time.startsWith(dateKey));
                if (pulls.length === 0) return;
                const listHtml = pulls.map(p => `<li><span class="rarity-${p.rank_type}">${p.name}</span></li>`).join('');
                showModal({ title: `Pulls for ${dateKey}`, customHtml: `<ul class="pull-breakdown-list">${listHtml}</ul>`, confirmText: 'Close' });
            }

            function analyzeBannerData(wishes, bannerType) {
                if (wishes.length === 0) return null;
                const oldToNew = [...wishes].reverse();
                let fiveStars = [], fourStars = [], p5 = 0, p4 = 0;
                oldToNew.forEach(w => { p5++; p4++; if (w.rank_type === '5') { fiveStars.push({ ...w, pity: p5 }); p5 = 0; } if (w.rank_type === '4') { fourStars.push({ ...w, pity: p4 }); p4 = 0; } });
                
                let wins = [], losses = [];
                if (bannerType === 'character') {
                    let guaranteed = false;
                    fiveStars.forEach(star => { if (STANDARD_5_STARS.includes(star.name)) { star.win = false; losses.push(star); guaranteed = true; } else { star.win = true; if (!guaranteed) wins.push(star); guaranteed = false; } });
                } else { fiveStars.forEach(star => star.win = true); }
                
                const avg = arr => arr.length ? arr.reduce((s, i) => s + i.pity, 0) / arr.length : 0;
                
                let fourStarChars = [], fourStarWeapons = [];
                if (bannerType === 'character') {
                    fourStars.forEach(star => { if (star.item_type === 'Character') fourStarChars.push(star); else fourStarWeapons.push(star); });
                }

                return {
                    totalWishes: wishes.length,
                    five: { list: fiveStars.reverse(), total: fiveStars.length, avgPity: avg(fiveStars), percent: (fiveStars.length / wishes.length) * 100, wins: wins.length, winRate: (wins.length + losses.length) > 0 ? (wins.length / (wins.length + losses.length)) * 100 : 0 },
                    four: { total: fourStars.length, avgPity: avg(fourStars), percent: (fourStars.length / wishes.length) * 100, chars: { total: fourStarChars.length, avgPity: avg(fourStarChars), percent: (fourStarChars.length / wishes.length) * 100 }, weapons: { total: fourStarWeapons.length, avgPity: avg(fourStarWeapons), percent: (fourStarWeapons.length / wishes.length) * 100 } },
                    pity: { current5: p5, current4: p4 }
                };
            }
            
            async function toggleTask(type, index) {
                const list = type === 'daily' ? state.dailyTasks : state.weeklyTasks;
                const task = list[index];
                if (task.completed) return;
                if (type === 'daily' && task.name.toLowerCase().includes('commission')) {
                    state.primogemCount += 60;
                    await showModal({ type: 'alert', title: 'Primogems Added!', message: '+60 Primogems from daily commissions have been added.', confirmText: 'OK' });
                }
                task.completed = true; saveState(); renderAll();
            }

            async function handleEventTaskClick(index) {
                const task = state.dailyTasks[index];
                if(task.completed) return;
                const value = await showModal({ type: 'prompt', title: 'Event Primogems', message: "How many Primogems did you earn?", placeholder: 'e.g., 420' });
                if (value === false) return;
                const amount = parseInt(value, 10);
                if (!isNaN(amount) && amount >= 0) {
                    state.primogemCount += amount; task.completed = true; saveState(); renderAll();
                } else if (value) {
                    await showModal({ type: 'alert', title: 'Invalid Input', message: 'Please enter a valid number.', confirmText: 'OK' });
                }
            }

            async function performDailyReset(isAuto = false) {
                const wasPerfectDay = state.dailyTasks.every(t => t.completed);
                if(wasPerfectDay) state.dailyStreak++; else state.dailyStreak = 0;
                state.dailyTasks.forEach(task => { task.streak = task.completed ? task.streak + 1 : 0; task.completed = false; });
                state.dailyResetsSinceWeekly = (state.dailyResetsSinceWeekly + 1) % 7;
                state.lastDailyReset = getAppDate().toISOString();
                if (state.dailyResetsSinceWeekly === 0) {
                    state.weeklyTasks.forEach(task => { task.streak = task.completed ? task.streak + 1 : 0; task.completed = false; });
                }
                saveState(); renderAll();
                if(!isAuto) await showModal({type:'alert', title:'Reset Complete', message:'Daily and weekly tasks have been reset.', confirmText:'OK'});
            }
            const checkForAutomaticResets = async () => { if (getAppDate().toDateString() !== new Date(state.lastDailyReset).toDateString()) await performDailyReset(true); };
            
            async function handleGachaImport(url) {
                getEl('gacha-stats-container').innerHTML = `<p style="text-align:center; padding: 20px;">Importing... this may take a moment.</p>`;
                const CORS_PROXY = 'https://corsproxy.io/?';
                const bannerTypes = [{ id: '301', name: 'Character Event' }, { id: '302', name: 'Weapon Event' }, { id: '200', 'name': 'Standard' }, { id: '100', name: 'Novice'}];
                let allWishes = state.gachaLog?.wishes || [];
                const existingWishIds = new Set(allWishes.map(w => w.id));
                try {
                    const urlObj = new URL(url);
                    const baseUrl = `${urlObj.protocol}//${urlObj.host}${urlObj.pathname}`;
                    const baseParams = new URLSearchParams(urlObj.search);
                    for (const banner of bannerTypes) {
                        let endId = '0', page = 1, foundExistingWish = false;
                        while (!foundExistingWish) {
                            const currentParams = new URLSearchParams(baseParams);
                            currentParams.set('gacha_type', banner.id); currentParams.set('size', '20'); currentParams.set('end_id', endId);
                            const fetchUrl = `${CORS_PROXY}${encodeURIComponent(`${baseUrl}?${currentParams.toString()}`)}`;
                            const response = await fetch(fetchUrl);
                            if (!response.ok) throw new Error(`Network error for ${banner.name}.`);
                            const data = await response.json();
                            if (data.retcode !== 0) break;
                            const newWishes = data.data?.list || [];
                            if (newWishes.length === 0) break;
                            for (const wish of newWishes) { if (existingWishIds.has(wish.id)) { foundExistingWish = true; } else { allWishes.push(wish); } }
                            endId = newWishes[newWishes.length - 1].id; page++;
                            await new Promise(resolve => setTimeout(resolve, 300));
                        }
                    }
                    const uniqueWishes = Array.from(new Map(allWishes.map(w => [w.id, w])).values());
                    uniqueWishes.sort((a, b) => new Date(b.time) - new Date(a.time));
                    state.gachaLog = { wishes: uniqueWishes, lastImport: new Date().toISOString() };
                    saveState(); renderAll();
                } catch (error) { await showModal({type:'alert', title:'Import Failed', message: error.message, confirmText:'OK'}); renderAll(); }
            }

            function bindEventListeners() {
                document.querySelectorAll('.menu-button, #menu-btn-settings').forEach(b => b.addEventListener('click', () => showView(b.dataset.view)));
                getEl('btn-back-main').addEventListener('click', () => showView('main-menu'));
                setInterval(() => getEl('live-clock').textContent = new Date().toLocaleTimeString('en-US', { hour12: true, hour: '2-digit', minute: '2-digit' }), 1000);
                
                getEl('copy-script-btn').addEventListener('click', () => {
                    navigator.clipboard.writeText(getEl('powershell-script').textContent);
                    const btn = getEl('copy-script-btn');
                    btn.textContent = 'Copied!';
                    setTimeout(() => btn.textContent = 'Copy', 2000);
                });
                
                getEl('add-primo-btn').addEventListener('click', async () => { const v = await showModal({type:'prompt', title:'Add Primogems', placeholder:'e.g., 300'}); if(v){state.primogemCount+=parseInt(v,10)||0; saveState(); renderPrimos();} });
                getEl('set-goal-btn').addEventListener('click', async () => { const v = await showModal({type:'prompt', title:'Set Goal', placeholder: 'e.g., 28800'}); if(v){state.primogemGoal=parseInt(v,10)||16000; saveState(); renderPrimos();} });
                
                getEl('import-gacha-btn').addEventListener('click', async () => { 
                    const url = await showModal({type:'prompt', title:'Import Gacha Log', message: 'Please paste your full gacha log URL.', placeholder:'https://...'}); 
                    if(url){
                        state.calendarDisplayYear = new Date().getFullYear(); 
                        await handleGachaImport(url);
                    } 
                });
                
                getEl('manual-reset-btn').addEventListener('click', () => performDailyReset(false));
                
                getEl('reset-primo-btn').addEventListener('click', async () => {
                    if (await showModal({title:'Confirm Primogem Reset', message:'This will reset your Primogem count to 0. This cannot be undone.', type:'confirm'})) {
                        state.primogemCount = 0;
                        saveState();
                        renderPrimos();
                    }
                });

                getEl('set-date-btn').addEventListener('click', async () => {
                    const confirmed = await showModal({
                        title: 'Set Custom Date',
                        customHtml: `<p style="margin-top:0; margin-bottom: 15px;">Select a date. The app will use this for daily checks.</p><input type="date" id="custom-date-input-modal" class="modal-input" style="display:block;" value="${state.customDate || toLocalISOString(getAppDate())}">`,
                        confirmText: 'Set Date'
                    });

                    if (confirmed) {
                        const newDate = getEl('custom-date-input-modal').value;
                        if(newDate) {
                            state.customDate = newDate;
                            saveState();
                            renderAll();
                            checkForAutomaticResets();
                        }
                    }
                });

                getEl('sync-date-btn').addEventListener('click', () => {
                    state.customDate = null;
                    saveState();
                    renderAll();
                });

                getEl('reset-all-btn').addEventListener('click', async () => { if(await showModal({title:'Confirm Total Reset', message:'This will delete all saved data. This cannot be undone.', type:'confirm'})){localStorage.removeItem(STORAGE_KEY); location.reload();} });
                
                getEl('prev-year-btn').addEventListener('click', () => { state.calendarDisplayYear--; renderCalendar(); saveState(); });
                getEl('next-year-btn').addEventListener('click', () => { if (state.calendarDisplayYear < getAppDate().getFullYear()) { state.calendarDisplayYear++; renderCalendar(); saveState(); } });
            }

            setViewHTML();
            loadState();
            checkForAutomaticResets();
            bindEventListeners();
            showView('main-menu');
            renderAll();
            saveState();
        });
    </script>
</body>
</html>